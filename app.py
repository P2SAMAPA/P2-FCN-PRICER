import streamlit as st; import numpy as np; import pandas as pd; import yfinance as yf; from scipy.optimize import brentq st.set_page_config(page_title="Institutional Derivatives Lab", layout="wide") st.markdown("<style>.stMetric { background-color: #ffffff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }</style>", unsafe_allow_html=True) with st.sidebar: st.header("ðŸ¢ Product Architect") mode = st.selectbox("Structure", ["FCN Version 1", "FCN Version 2 (Step-Down)", "BCN Solver"]) tks_in = st.text_input("Underlying Basket", "AMZN, ALB") tks = [x.strip().upper() for x in tks_in.split(",")] st.divider() stk_pct = st.slider("Put Strike (%)", 40, 100, 75) ko_pct = st.slider("Autocall Level (%)", 80, 120, 100) freq_opt = st.selectbox("Coupon Frequency", ["Monthly", "Quarterly"]) freq_m = 1 if freq_opt == "Monthly" else 3 tenor = st.number_input("Tenor (Years)", 0.25, 5.0, 1.0, 0.25) nc_m = st.number_input("Non-Call (Months)", 0, 24, 3) st.divider() rf_source = st.selectbox("Base Rate Source", ["3m T-Bill", "1 Year UST", "SOFR", "3m T-Bill + Spread"]) spread = st.slider("Spread (%)", 0.0, 5.0, 1.0, 0.1) if "Spread" in rf_source else 0.0 @st.cache_data(ttl=3600) def get_base_rate(): try: return yf.Ticker("^IRX").history(period="1d")['Close'].iloc[-1] / 100 except: return 0.045 r_final = get_base_rate() + (spread / 100); sd_val = st.slider("Step-Down (%)", 0.0, 2.0, 0.0) if "Version 2" in mode else 0 @st.cache_data(ttl=600) def get_mkt(tickers): v, p, d, names = [], [], [], [] for t in tickers: s = yf.Ticker(t); h = s.history(period="2y")['Close'] if h.empty: continue p.append(h); names.append(t) d.append(s.info.get('dividendYield', 0.012) or 0.012) v.append(h.pct_change().tail(252).std() * np.sqrt(252)) return np.array(v), pd.concat(p, axis=1).pct_change().dropna().corr().values, np.array(d), names def run_mc(cpn, paths, r, t, stk, ko, f_m, nc_m, mode, sd): steps, n_s, _ = paths.shape; wo = np.min(paths, axis=2); obs = np.arange(int((f_m/12)252), steps, int((f_m/12)252)) pay, act, acc = np.zeros(n_s), np.ones(n_s, dtype=bool), np.zeros(n_s); c_val = (cpn * (f_m/12)) * 100 for i, step in enumerate(obs): cur_ko = ko - (i * sd) if "Version 2" in mode else ko; acc[act] += c_val if step >= int((nc_m/12)252): k = act & (wo[step] >= cur_ko); pay[k] = 100 + acc[k]; act[k] = False if np.any(act): pay[act] = np.where(wo[-1, act] >= stk, 100, wo[-1, act]) + acc[act] return np.mean(pay) * np.exp(-r * t), (np.sum(wo[-1] < stk)/n_s) st.title(f"ðŸš€ {mode} Terminal") if st.button("RUN PRICING"): vols, corr, divs, names = get_mkt(tks); n_s, n_d = 15000, int(tenor * 252); L = np.linalg.cholesky(corr + np.eye(len(vols)) * 1e-10) dt = 1/252; drift = (r_final - divs - 0.5 * vols**2) * dt noise = np.einsum('ij,tkj->tki', L, np.random.standard_normal((n_d, n_s, len(vols)))) rets = drift + (vols * np.sqrt(dt)) * noise; paths = np.vstack([np.ones((1, n_s, len(vols)))100, 100 * np.exp(np.cumsum(rets, axis=0))]) try: sol = brentq(lambda x: run_mc(x, paths, r_final, tenor, stk_pct, ko_pct, freq_m, nc_m, mode, sd_val)[0]-100, 0, 1.5) _, loss = run_mc(sol, paths, r_final, tenor, stk_pct, ko_pct, freq_m, nc_m, mode, sd_val) c1, c2, c3 = st.columns(3); c1.metric("ANNUAL YIELD", f"{sol100:.2f}%"); c2.metric("CAPITAL LOSS PROB", f"{loss100:.1f}%"); c3.metric("COUPON EVENTS", f"{int(tenor * (12/freq_m))}") st.subheader("ðŸ“Š Sensitivity: Yield % (KO vs Strike)") ko_r, stk_r = [ko_pct-5, ko_pct, ko_pct+5], [stk_pct-10, stk_pct-5, stk_pct, stk_pct+5, stk_pct+10] y_m, l_m = [], [] for k in ko_r: yr, lr = [], [] for s in stk_r: try: sy = brentq(lambda x: run_mc(x, paths, r_final, tenor, s, k, freq_m, nc_m, mode, sd_val)[0]-100, 0, 2.0) _, sl = run_mc(sy, paths, r_final, tenor, s, k, freq_m, nc_m, mode, sd_val); yr.append(f"{sy100:.1f}%"); lr.append(f"{sl100:.1f}%") except: yr.append("N/A"); lr.append("N/A") y_m.append(yr); l_m.append(lr) st.table(pd.DataFrame(y_m, index=[f"KO {k}%" for k in ko_r], columns=[f"Stk {s}%" for s in stk_r])) st.subheader("ðŸ“‰ Sensitivity: Loss Prob %"); st.table(pd.DataFrame(l_m, index=[f"KO {k}%" for k in ko_r], columns=[f"Stk {s}%" for s in stk_r])) except Exception as e: st.error(f"Error: {e}") st.divider(); col_a, col_b = st.columns(2); col_a.write("Correlation"); col_a.dataframe(pd.DataFrame(corr, index=names, columns=names).style.format("{:.2f}")); col_b.write("Market Data"); col_b.table(pd.DataFrame({"Asset": names, "Vol": vols, "Div": divs}))
